!function(e){var t={};function n(i){if(t[i])return t[i].exports;var s=t[i]={i:i,l:!1,exports:{}};return e[i].call(s.exports,s,s.exports,n),s.l=!0,s.exports}n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)n.d(i,s,function(t){return e[t]}.bind(null,s));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=3)}([function(e,t){e.exports=require("crypto")},function(e,t){e.exports=require("date-fns")},function(e,t){e.exports=require("jsonwebtoken")},function(e,t,n){(function(e){const t=n(4),i=t(),s=n(5);port=process.env.PORT||8080;const r=n(6).path,o=n(7);o.setFfmpegPath(r);const a=n(0),d=n(1),u=n(8),g=n(9),{BlobServiceClient:m}=n(10),c=n(11),l=n(12),f=n(2),p=n(13)({dest:process.cwd()+"/my-app/src/assets/files/",limits:{fileSize:52428800}});n(14).config();n(15);const b=n(16),{getVideoDurationInSeconds:y}=n(17),{getAudioDurationInSeconds:E}=n(18),h=n(19),w=n(20);i.use(t.json()),i.use(c()),i.use(s.json()),i.use(t.static(process.cwd()+"/my-app/dist"));var I=null;console.log("Node Server läuft in Development"),(I=u.createConnection({host:"localhost",user:"root",password:"password",database:"teamprojekt"})).connect((function(e){if(e)throw e;console.log("production DB Connected!")}));const R=i.listen(port,()=>{console.log("Server listening on the port::"+port)});i.get(/^((?!\/api\/).)*$/,(function(e,t){t.sendFile(process.cwd()+"/my-app/dist/index.html")}));const q=n(21)(R,{rejectUnauthorized:!1,cors:{origin:"*"}});n(22).start(q,I),i.get("/api/users",w.isLoggedIn,(function(e,t,n){I.query("SELECT id, name FROM benutzer",(function(e,n){if(e)throw e;return t.send(n)}))})),i.post("/api/file/upload",w.isLoggedIn,p.single("file"),(e,t,n,i)=>{if(e)return n.status(200).json({msg:"File is too big! The limit is 50 MB."});i()},(function(t,n,i){let s=null,r=null,u=null,m=null,c=[{width:0,height:0,length:0}];if(void 0===t.file)return n.status(200).json({msg:"Server Error!"});var l;if(l=t.file.mimetype,r=["audio/aac","audio/opus","audio/ogg","audio/mpeg","audio/wav","audio/webm"].includes(l)?"audio":["video/mpeg","video/mp4","video/ogg","video/webm"].includes(l)?"video":["image/png","image/jpeg","image/gif","image/bmp","image/svg+xml"].includes(l)?"image":"file","file"==r)return n.status(200).json({msg:"Only image, audio and video allowed!"});u=t.file.originalname,s=+new Date+a.createHash("sha1").update(u).digest("hex"),m=e+"/my-app/src/assets/files/"+r+"/"+s+"."+u.split(".")[1];var f=t.file.path,p=m,w="./my-app/src/assets/files/thumbnail/"+s+".png",R={ratio:.6,opacity:.6,dstPath:w};async function q(e,t){}function v(){userid=t.body.userid,angebotname=t.body.name,kategorie=t.body.kategorie,tags=t.body.tags,username=t.body.username,I.query("INSERT INTO medium (user_id, dateiname, pfad, thumbnailpfad, dateityp, metadaten, datum_hinzugefuegt) VALUES (?, ?, ?, ?, ?, ?, ?)",[userid,u,r+"/"+s+"."+u.split(".")[1],"thumbnail/"+s+".png",r,JSON.stringify(c),d.format(new Date,"yyyy-MM-dd' 'HH:mm:ss")],(function(e,t){if(e)throw e;return n.status(200).send({msg:"The file has been uploaded successfully!"})}))}g.rename(f,p,(function(e){if(e)throw e;q(m,!1).then(()=>function(){if("image"==r){var e=b(m);c[0].width=e.width,c[0].height=e.height,v()}else"video"==r?y(m).then(e=>{c[0].length=e,v()}):"audio"==r&&E(m).then(e=>{c[0].length=e,v()})}()).then(()=>{return"video"==r?(e=s,void o(m).on("filenames",(function(e){console.log("Thumbnailname ist: "+e.join(", "))})).on("end",(function(){q(w,!0).then(()=>console.log("Thumbnail hochgeladen")).catch(e=>console.log(e.message))})).on("error",(function(e){console.log("an error happened: "+e.message)})).takeScreenshots({count:1,timemarks:["00:00:02.000"],size:"300x200",filename:e.split(".")[0]+".png"},"./my-app/src/assets/files/thumbnail/")):console.log("Kein Video");var e}).then(()=>{return"image"==r?(e=p,void h.addWatermark(e,"./my-app/src/assets/studystock.png",R).then(e=>{}).catch(e=>{console.log(e)})):console.log("Kein Image");var e}).then(()=>console.log("Files hochgeladen")).catch(e=>console.log(e.message))}))})),i.post("/api/offer/create",w.isLoggedIn,(function(e,t,n){I.query("INSERT INTO angebot (username, name, description, item_id, preis, kategorie, tags, lizenz, freigeschaltet, datum_angebot, reviews, rating, avg_rating, rated) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ? ,?)",[e.body.params.username,e.body.params.name,e.body.params.description,e.body.params.itemid,e.body.params.price,e.body.params.category,e.body.params.tags,e.body.params.license,0,d.format(new Date,"yyyy-MM-dd' 'HH:mm:ss"),0,0,0,""],(function(e,n){return e?t.send("Angebot bereits vorhanden"):(console.log("1 record inserted"),t.send("Angebot erstellt"))}))})),i.post("/api/service",w.isLoggedIn,(function(e,t,n){console.log(e.body.params),I.query("INSERT INTO service (username, name, description, kategorie, tags, pfad, freigeschaltet, datum_angebot, reviews, rating, avg_rating, rated) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)",[e.body.params.username,e.body.params.name,e.body.params.description,e.body.params.category,e.body.params.tags,e.body.params.path,0,d.format(new Date,"yyyy-MM-dd' 'HH:mm:ss"),0,0,0,""],(function(e,n){return e?t.send("Service bereits vorhanden"):(console.log("1 record inserted"),t.status(200).send({msg:"Service created successfully!"}))}))})),i.post("/api/request",w.isLoggedIn,(function(e,t,n){I.query("INSERT INTO anfrage (user_id, angebot_id, bestaetigt) VALUES (?, ?, ?)",[e.body.userid,e.body.angebotid,0],(function(e,n){return e?"ER_DUP_ENTRY"===e.code?t.send("Downloadanfrage wurde bereits gesendet"):void 0:(console.log("1 record inserted"),t.send("Downloadanfrage gesendet"))}))})),i.put("/api/request",w.isLoggedIn,(function(e,t,n){I.query("UPDATE anfrage SET bestaetigt = 1 WHERE user_id = "+e.body.params.userid+" AND angebot_id = "+e.body.params.angebotid,(function(e,n){if(e)throw e;return console.log("1 record updated"),t.send("Anfrage bestätigt")}))})),i.delete("/api/request",w.isLoggedIn,(function(e,t,n){I.query("DELETE FROM anfrage WHERE user_id = "+e.query.userid+" AND angebot_id = "+e.query.angebotid,(function(e,n){if(e)throw e;return console.log("1 record deleted"),t.send("Anfrage abgelehnt")}))})),i.get("/api/request",w.isLoggedIn,(function(e,t,n){I.query("SELECT user_id, angebot_id, bestaetigt FROM anfrage WHERE user_id = "+e.query.userid+" AND angebot_id = "+e.query.offerid,(function(e,n){if(e)throw e;return t.send(n)}))})),i.get("/api/requests",w.isLoggedIn,(function(e,t,n){I.query('SELECT user_id, angebot_id, bestaetigt, angebot.name as angebotname, benutzer.name as anfragename FROM anfrage INNER JOIN angebot ON angebot_id = angebot.id INNER JOIN benutzer ON user_id = benutzer.id WHERE username = "'+e.query.username+'" AND bestaetigt = 0',(function(e,n){if(e)throw e;return t.send(n)}))})),i.delete("/api/medium",w.isLoggedIn,(function(e,t,n){I.query("DELETE FROM medium WHERE id = "+e.query.id,(function(n,i){if(n)throw n;return console.log("1 record deleted"),I.query("DELETE FROM angebot WHERE item_id = "+e.query.id,(function(e,t){if(e)throw e;console.log("1 record deleted")})),t.send("Medium gelöscht")}))})),i.get("/api/downloads",w.isLoggedIn,(function(e,t,n){I.query("SELECT download.user_id, download.item_id, download.datum, medium.dateiname, medium.pfad, medium.thumbnailpfad, medium.dateityp, angebot.username, angebot.name, angebot.preis, angebot.kategorie, angebot.tags FROM download, medium, angebot WHERE download.user_id = "+e.query.userid+" AND download.item_id = medium.id AND download.item_id = angebot.item_id GROUP BY item_id",(function(e,n){if(e)throw e;return t.send(n)}))})),i.get("/api/offers",w.isLoggedIn,(function(e,t,n){I.query("SELECT angebot.id, angebot.username, angebot.name, angebot.item_id, angebot.preis, angebot.kategorie, angebot.tags, angebot.lizenz, angebot.freigeschaltet, angebot.datum_angebot, medium.id as mediumid, medium.user_id, medium.dateiname, medium.pfad, medium.thumbnailpfad, medium.dateityp, medium.metadaten, medium.datum_hinzugefuegt FROM angebot INNER JOIN medium ON angebot.item_id = medium.id WHERE medium.user_id = "+e.query.userid+" AND angebot.freigeschaltet = 1",(function(e,n){if(e)throw e;return t.send(n)}))})),i.put("/api/offer/accept",w.isLoggedIn,(function(e,t,n){I.query("UPDATE angebot SET freigeschaltet = 1 WHERE id = "+e.body.params.angebotid,(function(e,n){if(e)throw e;return console.log("1 record updated"),t.send("Angebot freigeschaltet")}))})),i.delete("/api/offer/decline",w.isLoggedIn,(function(e,t,n){I.query("DELETE FROM angebot WHERE id = "+e.query.angebotid,(function(e,n){if(e)throw e;return console.log("1 record deleted"),t.send("Angebot abgelehnt")}))})),i.delete("/api/offer",w.isLoggedIn,(function(e,t,n){I.query("DELETE FROM angebot WHERE id = "+e.query.angebotid,(function(e,n){if(e)throw e;return console.log("1 record deleted"),t.send("Angebot gelöscht")}))})),i.get("/api/services",w.isLoggedIn,(function(e,t,n){I.query('SELECT service.id, service.username, service.name, service.kategorie, service.tags, service.pfad, service.freigeschaltet, service.datum_angebot FROM service WHERE service.username = "'+e.query.username+'"',(function(e,n){if(e)throw e;return t.send(n)}))})),i.put("/api/profil/lock",w.isLoggedIn,(function(e,t,n){I.query("UPDATE angebot SET freigeschaltet = 0 WHERE username = ?  AND preis > 0",[e.body.params.username],(function(e,n){if(e)throw e;return console.log("1 record deleted"),t.send("Angebot abgelehnt")}))})),i.put("/api/offer/lock",w.isLoggedIn,(function(e,t,n){I.query("UPDATE angebot SET freigeschaltet = 0 WHERE id = "+e.body.params.angebotid,(function(e,n){if(e)throw e;return console.log("1 record deleted"),t.send("Angebot abgelehnt")}))})),i.get("/api/angebote",w.isLoggedIn,(e,t)=>{let n=e.query.sortBy,i=e.query.price,s=e.query.type;var r="SELECT angebot.id, angebot.avg_rating, angebot.reviews, angebot.username, dateiname, medium.id as mediumid, pfad, thumbnailpfad, name, preis, lizenz, kategorie, dateityp, datum_angebot, metadaten, tags, user_id FROM angebot INNER JOIN medium ON angebot.item_id = medium.id WHERE angebot.freigeschaltet = 1 AND angebot.name LIKE'%"+e.query.query+"%' OR angebot.freigeschaltet = 1 AND angebot.kategorie LIKE'%"+e.query.query+"%' OR angebot.freigeschaltet = 1 AND angebot.tags LIKE'%"+e.query.query+"%' ";"All"==i?r+="HAVING preis >= 0 ":"Free"==i?r+="HAVING preis = 0 ":"Under 10 Euro"==i?r+="HAVING preis between 0 AND 10 ":"Under 50 Euro"==i?r+="HAVING preis between 0 AND 50 ":"Under 100 Euro"==i&&(r+="HAVING preis between 0 AND 100 "),"All"==s?r+="":"Audio"==s?r+='AND dateityp = "audio" ':"Video"==s?r+='AND dateityp = "video" ':"Image"==s?r+='AND dateityp = "image" ':"Service"==s&&(r+='AND dateityp = "service" '),"Latest"==n?r+="ORDER BY datum_angebot DESC":"Oldest"==n?r+="ORDER BY datum_angebot ASC":"Best rated"==n?r+="ORDER BY rating DESC":"Lowest price"==n?r+="ORDER BY preis ASC":"Highest price"==n&&(r+="ORDER BY preis DESC"),I.query(r,(function(e,n){if(e)throw e;return t.send(n)}))}),i.get("/api/pendingoffers",w.isLoggedIn,(e,t)=>{I.query("SELECT angebot.id, angebot.username, angebot.name, angebot.item_id, angebot.preis, angebot.kategorie, angebot.tags, angebot.lizenz, angebot.freigeschaltet, angebot.datum_angebot, medium.id as mediumid, medium.user_id, medium.dateiname, medium.pfad, medium.thumbnailpfad, medium.dateityp, medium.metadaten, medium.datum_hinzugefuegt FROM angebot INNER JOIN medium ON angebot.item_id = medium.id WHERE freigeschaltet = 0",(function(e,n){if(e)throw e;return t.send(n)}))}),i.get("/api/angebot",w.isLoggedIn,(e,t)=>{I.query("SELECT angebot.id, medium.user_id, username, dateiname, datum_angebot, metadaten, tags, name, description, pfad, thumbnailpfad, preis, lizenz, kategorie, dateityp FROM angebot INNER JOIN medium ON angebot.item_id = medium.id WHERE angebot.id ='"+e.query.id+"' ",(function(e,n){if(e)throw e;return t.send(n)}))}),i.get("/api/inventory",w.isLoggedIn,(e,t)=>{I.query("SELECT * FROM medium WHERE user_id ="+e.query.userid,(function(e,n){if(e)throw e;return t.send(n)}))}),i.get("/api/download",w.isLoggedIn,(e,t)=>{I.query("SELECT medium.pfad, dateityp FROM angebot INNER JOIN medium ON angebot.item_id = medium.id WHERE angebot.id = '"+e.query.itemid+"' ",(function(e,n){if(e)throw e;t.set({"Content-Disposition":'attachment; filename="'+n[0].pfad.split("/")[1]+'"'})}))}),i.post("/api/file/download",w.isLoggedIn,(e,t)=>{I.query("INSERT INTO download (user_id, item_id, datum) VALUES (?, ?, ?)",[e.body.params.userid,e.body.params.itemid,d.format(new Date,"yyyy-MM-dd' 'HH:mm:ss")],(function(e,n){if(e)throw e;t.send("Download erfolgreich")}))}),i.post("/api/message",w.isLoggedIn,(e,t)=>{I.query("INSERT INTO nachricht (sender_id, receiver_id, inhalt, gelesen, datum_geschrieben) VALUES (?, ?, ?, ?, ?)",[e.body.senderid,e.body.receiverid,e.body.inhalt,!1,d.format(new Date,"yyyy-MM-dd' 'HH:mm:ss")],(function(e,n){if(e)throw e;t.send("Nachricht gesendet")}))}),i.get("/api/message",w.isLoggedIn,(e,t)=>{I.query("SELECT sender_id, inhalt, datum_geschrieben FROM nachricht WHERE receiver_id = "+e.query.receiverid+" AND sender_id = "+e.query.senderid+" OR receiver_ID = "+e.query.senderid+" AND sender_id = "+e.query.receiverid,(function(e,n){if(e)throw e;t.send(n)}))}),i.put("/api/message",w.isLoggedIn,(e,t)=>{I.query("UPDATE nachricht SET gelesen = 1 WHERE receiver_id = "+e.body.params.receiverid+" AND sender_id = "+e.body.params.senderid,(function(e,t){if(e)throw e;console.log("1 record updated - Nachrichten auf gelesen gesetzt")}))}),i.post("/api/register",w.validateRegister,(e,t,n)=>{I.query(`SELECT * FROM benutzer WHERE LOWER(name) = LOWER(${I.escape(e.body.username)});`,(n,i)=>{if(i.length)return t.status(409).send({msg:"This username is already in use!"});l.hash(e.body.password,10,(n,i)=>{if(n)return t.status(500).send({msg:n});I.query("INSERT INTO benutzer (name, password, email, rolle, datum_registration, last_login) VALUES (?, ?, ?, ?, ?, ?);",[e.body.username,i,e.body.email,0,d.format(new Date,"yyyy-MM-dd' 'HH:mm:ss"),d.format(new Date,"yyyy-MM-dd' 'HH:mm:ss")],(e,n)=>{if(e)throw e;return t.status(201).send({msg:"Registered!"})})})})}),i.post("/api/login",(e,t,n)=>{I.query(`SELECT * FROM benutzer WHERE name = ${I.escape(e.body.username)};`,(n,i)=>{if(n)throw n;if(!i.length)return t.status(401).send({msg:"Username or password is incorrect!"});l.compare(e.body.password,i[0].password,(e,n)=>{if(e)throw e;if(n){const e=f.sign({username:i[0].username,userId:i[0].id},"SECRETKEY",{expiresIn:"1d"});return I.query(`UPDATE benutzer SET last_login = now() WHERE id = '${i[0].id}'`),t.status(200).send({msg:"Logged in!",token:e,user:i[0]})}return t.status(401).send({msg:"Username or password is incorrect!"})})})}),i.get("/api/profil",w.isLoggedIn,(e,t)=>{I.query("SELECT * FROM benutzer WHERE id = "+e.query.userid,(function(e,n){if(e)throw e;return t.send(n)}))}),i.get("/api/user",w.isLoggedIn,(e,t)=>{I.query("SELECT * FROM benutzer WHERE id = "+e.query.userid,(function(e,n){if(e)throw e;return t.send(n)}))}),i.put("/api/profil/update",w.isLoggedIn,(e,t)=>{I.query("SELECT * FROM benutzer WHERE id = "+e.body.id,(function(n,i){if(n)throw n;let s=i[0].password,r=e.body.old_password,o=e.body.new_password_1,a=e.body.new_password_2;l.compare(r,s,(function(n,i){if(!i)return t.status(201).send({msg:"Please insert a valid password."});l.hash(o,10,(n,i)=>n?t.status(500).send({msg:n}):o.toString().length<6?t.status(201).send({msg:"Password must be at least 6 characters long."}):o!=a?t.status(201).send({msg:"Passwords do not match."}):void I.query("UPDATE benutzer SET password = ? WHERE id = "+e.body.id,[i],(e,n)=>{if(e)throw e;return t.status(201).send({msg:"Updated!"})}))}))}))}),i.delete("/api/profil/delete",w.isLoggedIn,(e,t)=>{I.query("DELETE FROM benutzer WHERE id = "+e.query.id,(function(e,n){if(e)throw e;return t.send("Profil gelöscht")}))}),i.put("/api/offer/rating",w.isLoggedIn,(function(e,t,n){I.query("UPDATE angebot SET rating = rating +  "+e.body.selectedRating+" WHERE id = "+e.body.angebot_id,(function(t,n){if(t)throw t;I.query("UPDATE angebot SET reviews = reviews + 1 WHERE id = "+e.body.angebot_id,(function(t,n){if(t)throw t;I.query("UPDATE angebot SET avg_rating = rating / reviews, rated = CONCAT(rated, ?) WHERE id = "+e.body.angebot_id,[e.body.user_id+","],(function(e,t){}))}))}))})),i.get("/api/offer/rating",w.isLoggedIn,(e,t)=>{I.query("SELECT id, rated, avg_rating, reviews FROM angebot WHERE id = "+e.query.angebot_id,(function(e,n){if(e)throw e;return t.send(n)}))}),i.get("/api/admin/users",w.isLoggedIn,(e,t)=>{I.query("SELECT * FROM benutzer",(function(e,n){if(e)throw e;return t.send(n)}))}),i.put("/api/user/lock",w.isLoggedIn,(e,t)=>{I.query("UPDATE benutzer SET rolle = 3 WHERE name = ?",[e.body.params.username])}),i.put("/api/user/unlock",w.isLoggedIn,(e,t)=>{I.query("UPDATE benutzer SET rolle = 1 WHERE name = ?",[e.body.params.username])}),i.get("/api/medium",w.isLoggedIn,(e,t)=>{I.query("SELECT id, pfad, thumbnailpfad, dateityp FROM medium WHERE id = "+e.query.medium_id,(function(e,n){if(e)throw e;return t.send(n)}))})}).call(this,"/")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("@ffmpeg-installer/ffmpeg")},function(e,t){e.exports=require("fluent-ffmpeg")},function(e,t){e.exports=require("mysql")},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("@azure/storage-blob")},function(e,t){e.exports=require("cors")},function(e,t){e.exports=require("bcryptjs")},function(e,t){e.exports=require("multer")},function(e,t){e.exports=require("dotenv")},function(e,t){e.exports=require("sharp")},function(e,t){e.exports=require("image-size")},function(e,t){e.exports=require("get-video-duration")},function(e,t){e.exports=require("get-audio-duration")},function(e,t){e.exports=require("jimp-watermark")},function(e,t,n){const i=n(2),s=/\.hs-fulda\.de$/gm;e.exports={validateRegister:(e,t,n)=>(console.log(e.body),!e.body.username||e.body.username.length<3?t.status(400).send({msg:"Please enter a username with min. 3 chars"}):!e.body.password||e.body.password.length<6?t.status(400).send({msg:"Please enter a password with min. 6 chars"}):e.body.password_repeat&&e.body.password==e.body.password_repeat?null==e.body.email.match(s)?t.status(400).send({msg:"Please enter a valid university mail"}):void n():t.status(400).send({msg:"Both passwords must match"})),isLoggedIn:(e,t,n)=>{try{const t=e.headers.authorization.split(" ")[1],s=i.verify(t,"SECRETKEY");e.userData=s,n()}catch(e){return t.status(401).send({msg:"Your session is not valid!"})}}}},function(e,t){e.exports=require("socket.io")},function(e,t,n){const i=n(0),s=n(1),{InMemorySessionStore:r}=n(23),o=new r,{InMemoryMessageStore:a}=n(24),d=new a;e.exports={start:function(e,t){e.use((e,n)=>{const s=e.handshake.auth.sessionID;if(s){const t=o.findSession(s);if(t)return e.sessionID=s,e.userID=t.userID,e.username=t.username,n()}const r=e.handshake.auth.username;if(!r)return n(new Error("invalid username"));t.query('SELECT id, name FROM benutzer WHERE name = "'+r+'"',(function(t,s){if(t)throw t;e.sessionID=i.randomBytes(8).toString("hex"),e.userID=s[0].id,e.username=r,n()}))}),e.on("connection",n=>{console.log(n.username+" hat sich verbunden");var i=null;t.query("SELECT id, receiver_id, sender_id, inhalt, gelesen, datum_geschrieben FROM nachricht WHERE receiver_id = "+n.userID+" OR sender_id = "+n.userID,(function(e,s){if(e)throw e;s.forEach(e=>{i={id:e.id,content:e.inhalt,from:e.sender_id,to:e.receiver_id,read:e.gelesen},d.saveMessage(i)}),o.saveSession(n.sessionID,{userID:n.userID,username:n.username,connected:!0}),n.emit("session",{sessionID:n.sessionID,userID:n.userID}),n.join(n.userID);const r=[],a=new Map;d.findMessagesForUser(n.userID).forEach(e=>{const{from:t,to:i}=e,s=n.userID===t?i:t;a.has(s)?a.get(s).push(e):a.set(s,[e])}),t.query("SELECT id, name FROM benutzer",(function(e,t){if(e)throw e;t.forEach(e=>{r.push({userID:e.id,username:e.name,connected:!1,messages:a.get(e.id)||[]})}),o.findAllSessions().forEach(e=>{for(let t=0;t<r.length;t++)r[t].username==e.username&&(r[t].connected=!0)}),n.emit("users",r),n.broadcast.emit("user connected",{userID:n.userID,username:n.username,connected:!0,messages:[]})}))})),n.on("private message",({content:e,to:i,offerID:r,initialOfferUser:o})=>{const a={content:e,from:n.userID,to:i};null!==r&&o==i&&t.query("INSERT INTO anfrage (user_id, angebot_id, bestaetigt) VALUES (?, ?, ?)",[n.userID,r,0],(function(e,t){e?"ER_DUP_ENTRY"===e.code&&console.log("Anfrage wurde bereits gesendet"):(console.log("1 record inserted"),console.log("Anfrage gesendet"))})),n.to(i).to(n.userID).emit("private message",a);let u=!1;i==n.userID&&(u=!0),t.query("INSERT INTO nachricht (sender_id, receiver_id, inhalt, gelesen, datum_geschrieben) VALUES (?, ?, ?, ?, ?)",[n.userID,i,e,u,s.format(new Date,"yyyy-MM-dd' 'HH:mm:ss")],(function(e,t){if(e)throw e})),d.saveMessage(a)}),n.on("disconnect",async()=>{console.log(n.username+" disconnected"),d.messages=[];0===(await e.in(n.userID).allSockets()).size&&(n.broadcast.emit("user disconnected",n.userID),o.saveSession(n.sessionID,{userID:n.userID,username:n.username,connected:!1}))})})}}},function(e,t){e.exports={InMemorySessionStore:class extends class{findSession(e){}saveSession(e,t){}findAllSessions(){}}{constructor(){super(),this.sessions=new Map}findSession(e){return this.sessions.get(e)}saveSession(e,t){this.sessions.set(e,t)}findAllSessions(){return[...this.sessions.values()]}}}},function(e,t){e.exports={InMemoryMessageStore:class extends class{saveMessage(e){}findMessagesForUser(e){}}{constructor(){super(),this.messages=[]}saveMessage(e){this.messages.push(e)}findMessagesForUser(e){return this.messages.filter(({from:t,to:n})=>t===e||n===e)}}}}]);